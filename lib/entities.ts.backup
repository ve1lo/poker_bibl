
import { Entity, PrimaryGeneratedColumn, Column, CreateDateColumn, UpdateDateColumn, OneToMany, ManyToOne, JoinColumn, Unique } from "typeorm"

@Entity()
export class Player {
    @PrimaryGeneratedColumn()
    id: number

    @Column({ type: 'text', unique: true })
    telegramId: string

    @Column({ type: 'text', nullable: true })
    username: string

    @Column({ type: 'text', nullable: true })
    firstName: string

    @Column({ type: 'text', nullable: true })
    lastName: string


    @Column({ type: 'datetime' })
    date: Date

    @Column({ type: 'text' })
    type: string // "PAID" | "FREE"

    @Column({ type: 'text', default: "SCHEDULED" })
    status: string // "SCHEDULED" | "RUNNING" | "PAUSED" | "FINISHED"

    @Column({ type: 'integer', nullable: true })
    buyIn: number | null

    @Column({ type: 'integer', default: 10000 })
    stack: number

    @Column({ type: 'text', nullable: true })
    config: string // JSON string

    // Timer State
    @Column({ type: 'integer', default: 0 })
    currentLevelIndex: number

    @Column({ type: 'datetime', nullable: true })
    levelStartedAt: Date | null

    @Column({ type: 'datetime', nullable: true })
    timerPausedAt: Date | null

    @Column({ type: 'integer', nullable: true })
    timerSeconds: number | null

    @Column({ type: 'boolean', default: false })
    registrationClosed: boolean

    @CreateDateColumn()
    createdAt: Date

    @UpdateDateColumn()
    updatedAt: Date

    @OneToMany(() => TournamentLevel, (level) => level.tournament, { cascade: true })
    levels: TournamentLevel[]

    @OneToMany(() => Registration, (registration) => registration.tournament, { cascade: true })
    registrations: Registration[]

    @OneToMany(() => GameEvent, (event) => event.tournament, { cascade: true })
    events: GameEvent[]
}

@Entity()
export class TournamentLevel {
    @PrimaryGeneratedColumn()
    id: number

    @Column({ type: 'integer' })
    levelNumber: number

    @Column({ type: 'integer' })
    smallBlind: number

    @Column({ type: 'integer' })
    bigBlind: number

    @Column({ type: 'integer', default: 0 })
    ante: number

    @Column({ type: 'integer' })
    duration: number // in minutes

    @Column({ type: 'boolean', default: false })
    isBreak: boolean

    @ManyToOne(() => Tournament, (tournament) => tournament.levels, { onDelete: "CASCADE" })
    tournament: Tournament
}

@Entity()
@Unique(["player", "tournament"])
export class Registration {
    @PrimaryGeneratedColumn()
    id: number

    @Column({ type: 'text', default: "REGISTERED" })
    status: string // "REGISTERED" | "ELIMINATED"

    @Column({ type: 'integer', default: 0 })
    rebuys: number

    @Column({ type: 'integer', default: 0 })
    addons: number

    @Column({ type: 'integer', nullable: true })
    place: number

    @Column({ type: 'integer', default: 0 })
    bountyCount: number

    @Column({ type: 'integer', nullable: true })
    points: number

    @CreateDateColumn()
    createdAt: Date

    @ManyToOne(() => Player, (player) => player.registrations, { onDelete: "CASCADE" })
    player: Player

    @ManyToOne(() => Tournament, (tournament) => tournament.registrations, { onDelete: "CASCADE" })
    tournament: Tournament
}

@Entity()
export class GameEvent {
    @PrimaryGeneratedColumn()
    id: number

    @Column({ type: 'text' })
    type: string

    @Column({ type: 'text' })
    description: string

    @CreateDateColumn()
    timestamp: Date

    @ManyToOne(() => Tournament, (tournament) => tournament.events, { onDelete: "CASCADE" })
    tournament: Tournament
}
